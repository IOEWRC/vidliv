{% extends 'base.html' %}
{% load static %}
{% block title_name %}VidLIV: Home{% endblock %}

{% block script %}
    <script src="{% static 'home/js/pubnub.js' %}"></script>
    <script src="{% static 'home/js/webrtc.js' %}"></script>
    <script src="{% static 'home/js/rtc-controller.js' %}"></script>
    <script src="{% static 'home/js/phone.js' %}"></script>
    <script type="text/javascript">
        const pubnubmain = window.pubnubmain = PUBNUB.init({
            publish_key: 'pub-c-84d6b42f-9d4d-48c1-b5a7-c313289e1792',
            subscribe_key: 'sub-c-2ebd9ad8-6cdb-11e8-902b-b2b3cb3accda',
            ssl: true
        });
        pubnubmain.subscribe({
            restore: true,
            channel: '{{ request.user.username }}',
            message: (message) => {
                if (message.type === 'callRequest') {
                    $('#acceptCallModal').modal({
                        closable: false
                    }).modal('show');
                    $('#denyCallButton').click(() => {
                        pubnubmain.publish({
                            channel: message.number,
                            message: {
                                type: 'callRequestDeny',
                                id: pubnubmain.get_uuid(),
                                number: '{{ request.user.username }}'
                            }
                        });
                    });
                    $('#acceptCallButton').click(() => {
                        pubnubmain.publish({
                            channel: message.number,
                            message: {
                                type: 'callRequestAccept',
                                id: pubnubmain.get_uuid(),
                                number: '{{ request.user.username }}'
                            },
                            callback: message => {
                                start_phone('{{ request.user.username }}', message.number, false);
                            }
                        });
                    });
                } else if (message.type === 'callRequestDeny') {
                    $('#requestCallModal').modal('hide');
                    $('#userNotAvailModal').modal({closable: false}).modal('show');
                } else if (message.type === 'callRequestAccept') {
                   start_phone('{{ request.user.username }}', message.number, true);
                } else if (message.type === 'callRequestCancel') {
                    // TODO add call request cancel methods
                }
            }
        });
        function startCall (username) {
            if (username === '{{ request.user.username }}') return;
            $('#requestCallModal').modal({
                closable: false
            }).modal('show');
            pubnubmain.publish({
                channel: username,
                message: {
                    type: 'callRequest',
                    id: pubnubmain.get_uuid(),
                    number: '{{ request.user.username }}'
                }
            });
        }
    </script>
{% endblock %}

{% block content %}
    <p><h1>Welcome to VidLIV</h1></p>
    <p>Coming soon</p>
    <div id="userList">
    <table class="ui teal table">
        <thead>
        <tr>
            <td>users</td>
            <td>actions</td>
        </tr>
        </thead>
        <tbody>
        {% for usr in user_list %}
            <tr>
            <td>{{ usr.username }}</td>
            <td>
                <button type="button" class="ui inverted teal button" id="myBtn" onclick="return startCall('{{ usr.username }}')">Call</button>
            </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    </div>
    {% block call %}{% include 'home/call.html' %}{% endblock %}
{% endblock %}