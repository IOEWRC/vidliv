{% extends 'base.html' %}
{% load static %}
{% block title_name %}VidLIV: Home{% endblock %}

{% block script %}
    <script src="{% static 'home/js/pubnub.js' %}"></script>
    <script src="{% static 'home/js/webrtc.js' %}"></script>
    <script src="{% static 'home/js/rtc-controller.js' %}"></script>
    <script type="text/javascript">
        {% if messages %}
            {% for message in messages %}
                generalModalFunction('{{ message.extra_tags }}', '{{ message }}');
            {% endfor %}
        {% endif %}
        const video_out = document.getElementById('vid-box');
        const vid_thumb = document.getElementById('vid-thumb');
        const phone = window.phone = PHONE({
            number: '{{ request.user.username }}',
            publish_key: 'pub-c-84d6b42f-9d4d-48c1-b5a7-c313289e1792',
            subscribe_key: 'sub-c-2ebd9ad8-6cdb-11e8-902b-b2b3cb3accda'
        });
        const ctrl = window.ctrl = CONTROLLER(phone, get_xirsys_servers);
        ctrl.receive(session => {
            session.connected(session => {
                $('#videoCallModal').modal({
                    closable: false
                }).modal('show');
                if ($('#vid-thumb video').length < 1) ctrl.addLocalStream(vid_thumb);
                video_out.appendChild(session.video);
            });
            session.ended(session => {
                ctrl.getVideoElement(session.number).remove();
                if ($('#vid-box video').length === 0) {
                    $('#vid-thumb').empty();
                    $('#videoCallModal').modal('hide');
                }
            })
        });
        ctrl.videoToggled((session, isEnabled) => {
            ctrl.getVideoElement(session.number).toggle(isEnabled);
        });
        ctrl.audioToggled((session, isEnabled)=> {
            ctrl.getVideoElement(session.number).css('opacity', isEnabled ? 1: 0.75);
        });
        function startCall(username) {
            if (!window.phone) alert("Currently not working.");
            if (phone.number() === username) return false;
            ctrl.isOnline(username, isOn => {
                if (isOn) {
                    $('#videoCallModal').modal({
                        closable: false
                    }).modal('show');
                    ctrl.dial(username);
                }
                else {
                    generalModalFunction(username + ' status', username + ' is OFFLINE!!!');
                }
            });
        }
        $('#endCallButton').click(() => {
            if (phone) ctrl.hangup();
        });
        $('#muteCallButton').click(() => {
            if (ctrl) {
                const audio = ctrl.toggleAudio();
                if (!audio) $('#muteCallButton').html('' +
                    '<i class="unmute icon"></i>\n' +
                    'Unmute');
                else $('#muteCallButton').html('' +
                    '<i class="mute icon"></i>\n' +
                    'Mute');
            }
        });
        $('#pauseCallButton').click(() => {
            if (ctrl) {
                const video = ctrl.toggleVideo();
                if (!video) $('#pauseCallButton').html('' +
                    '<i class="play icon"></i>\n' +
                    'Play');
                else $('#pauseCallButton').html('' +
                    '<i class="pause icon"></i>\n' +
                    'Pause');
            }
        });
        function addUser(username) {
            console.log('Adding ' + username);
            startCall(username);
        }
        $(window).bind('beforeunload', () => {
            if (phone) {
                phone.hangup();
                phone.unsubscribe();
            }
            if (ctrl) {
                ctrl.hangup();
                ctrl.unsubscribe();
            }
        });
        function watchLive(username, url) {
            ctrl.isStreaming(username, isOn =>{
               if (isOn) {console.log('a');
                   window.location.replace(window.location.protocol + '//' + window.location.host + url);}
               else {
                   generalModalFunction(username + ' streaming status', username + ' is not streaming !!!');
               }
            });
        }
    </script>
{% endblock %}

{% block content %}
        <div class="ui container">
            <p><h1>Welcome to VidLIV</h1></p>
            <a href="{% url 'home:golive'%}" class="ui red button"><i class="video icon"></i>GoLive</a>
        </div>
        <hr>
        <div class="ui stackable grid container">
            <div class="eight wide column">
                    <div id="userList" class="tableContainer">
                        <table class="ui teal table green scrollTable">
                      <thead class="fixedHeader">
                        <tr><th>Friends</th>
                        <th></th>
                      </tr></thead>
                      <tbody class="scrollContent">
                        {% for usr in user_list %}
                             <tr>
                              <td>
                                <h4 class="ui image header">
                                    {% if usr.profile.avatar %}
                                        <img src="{{ usr.profile.avatar.url }}" class="ui mini rounded image">
                                    {% else %}
                                        <img src="{% static 'img/matthew.png' %}" class="ui mini rounded image">
                                    {% endif %}
                                    <div class="content">
                                        {{ usr.username }}
                                    </div>
                              </h4></td>
                              <td>
                                <button type="button" class="ui inverted teal button" id="myBtn" onclick="return startCall('{{ usr.username }}')">Call</button>
                              </td>
                            </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    </div>
            </div>
            <div class="eight wide column">
                    <div id="userList1" class="tableContainer">
                        <table class="ui teal table green scrollTable">
                      <thead class="fixedHeader">
                        <tr><th>Streamers</th>
                        <th></th>
                      </tr></thead>
                      <tbody class="scrollContent">
                        {% for usr in user_list %}
                             <tr>
                              <td>
                                <h4 class="ui image header">
                                    {% if usr.profile.avatar %}
                                        <img src="{{ usr.profile.avatar.url }}" class="ui mini rounded image">
                                    {% else %}
                                        <img src="{% static 'img/matthew.png' %}" class="ui mini rounded image">
                                    {% endif %}
                                    <div class="content">
                                        {{ usr.username }}
                                    </div>
                              </h4></td>
                              <td>
                                <button type="button" class="ui red button" onclick="watchLive('{{ usr.username }}', '{% url "home:watchlive" username=usr.username %}')"><i class="play icon"></i>WatchLive</button>
                              </td>
                            </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    </div>
            </div>
        </div>
<div><br></div>
    {% block call %}{% include 'home/call.html' %}{% include 'home/base.html' %}{% endblock %}
{% endblock %}
{% block stylesheet %}
    <style>
        div.tableContainer {
	border: 1px solid #963;
	overflow: auto;
}

    /* Reset overflow value to hidden for all non-IE browsers. */
    html>body div.tableContainer {
        overflow: hidden;
        {#width: 900px#}
        }

    /* define width of table. IE browsers only                 */
    div.tableContainer table {
        float: left;
        width: 740px
    }

    thead.fixedHeader tr {
        position: relative;
    }

    html>body tbody.scrollContent {
        display: block;
        height: 350px;
        overflow: auto;
        width: 100%
    }

    html>body thead.fixedHeader {
        display: table;
        overflow: auto;
        width: 100%
    }
    </style>
{% endblock %}